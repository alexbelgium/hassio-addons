#!/usr/bin/with-contenv bashio
# shellcheck shell=bash
set -e

if ! bashio::config.true 'wireguard_enabled'; then
    exit 0
fi

wireguard_config="${WIREGUARD_CONFIG:-}"
wireguard_interface="${WIREGUARD_INTERFACE:-}"

if [ -z "${wireguard_config}" ] && [ -f /var/run/s6/container_environment/WIREGUARD_CONFIG ]; then
    wireguard_config="$(cat /var/run/s6/container_environment/WIREGUARD_CONFIG)"
fi

if [ -z "${wireguard_interface}" ] && [ -f /var/run/s6/container_environment/WIREGUARD_INTERFACE ]; then
    wireguard_interface="$(cat /var/run/s6/container_environment/WIREGUARD_INTERFACE)"
fi

wireguard_interface="${wireguard_interface:-wg0}"

if [ -z "${wireguard_config}" ]; then
    bashio::exit.nok "WireGuard service started without a configuration file."
fi

bashio::log.info "Starting WireGuard interface ${wireguard_interface} using ${wireguard_config}."

# Ensure we start from a clean state
wg-quick down "${wireguard_config}" >/dev/null 2>&1 || true

if ! wg-quick up "${wireguard_config}"; then
    bashio::exit.nok "Failed to start WireGuard interface ${wireguard_interface}."
fi

bashio::log.info "WireGuard interface ${wireguard_interface} is up."

# Keep the service alive while WireGuard is active
while true; do
    sleep 60
    if ! ip link show "${wireguard_interface}" >/dev/null 2>&1; then
        bashio::log.warning "WireGuard interface ${wireguard_interface} is no longer available. Attempting to restore."
        wg-quick up "${wireguard_config}" || bashio::log.warning "Automatic WireGuard restart failed."
    fi
done
