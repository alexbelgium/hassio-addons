#!/usr/bin/with-contenv bashio
# shellcheck shell=bash

WEBUI_PORT=${WEBUI_PORT:-8080}
VPN_INTERFACE_FILE="/var/run/vpn_interface"

if bashio::config.true 'silent'; then
    sed -i 's|/proc/1/fd/1 hassio;|off;|g' /etc/nginx/nginx.conf
fi

if bashio::config.true 'openvpn_enabled'; then
    exec /usr/sbin/openvpn --config /config/openvpn/config.ovpn --script-security 2 --up /etc/openvpn/up.sh --down /etc/openvpn/down.sh --pull-filter ignore "route-ipv6" --pull-filter ignore "ifconfig-ipv6" --pull-filter ignore "tun-ipv6" --pull-filter ignore "redirect-gateway ipv6" --pull-filter ignore "dhcp-option DNS6"
else
    wireguard_interface=""
    if bashio::config.true 'wireguard_enabled'; then
        if [ -f "${VPN_INTERFACE_FILE}" ]; then
            wireguard_interface=$(tr -d ' \t\n\r' < "${VPN_INTERFACE_FILE}")
        else
            wireguard_interface=$(bashio::config 'wireguard_interface' 'wg0')
        fi

        if [ -z "${wireguard_interface}" ]; then
            bashio::log.fatal "WireGuard interface name is empty."
            exit 1
        fi

        if [ ! -f "/etc/wireguard/${wireguard_interface}.conf" ]; then
            bashio::log.fatal "WireGuard configuration /etc/wireguard/${wireguard_interface}.conf not found."
            exit 1
        fi

        bashio::log.info "Starting WireGuard interface ${wireguard_interface}"
        if ! wg-quick up "${wireguard_interface}"; then
            bashio::log.fatal "Failed to start WireGuard interface ${wireguard_interface}"
            exit 1
        fi

        for _ in $(seq 1 10); do
            if ip link show dev "${wireguard_interface}" >/dev/null 2>&1; then
                break
            fi
            sleep 1
        done

        if ! ip link show dev "${wireguard_interface}" >/dev/null 2>&1; then
            bashio::log.warning "WireGuard interface ${wireguard_interface} did not become ready after 10 seconds."
        fi
    fi

    # shellcheck disable=SC2317  # called via trap on EXIT
    cleanup() {
        if [ -n "${wireguard_interface}" ]; then
            wg-quick down "${wireguard_interface}" >/dev/null 2>&1 || true
        fi
    }

    # shellcheck disable=SC2317  # called via traps on INT/TERM
    terminate() {
        if [ -n "${qb_pid:-}" ] && kill -0 "${qb_pid}" >/dev/null 2>&1; then
            kill "${qb_pid}" >/dev/null 2>&1 || true
        fi

        if [ -n "${qb_pid:-}" ] && [ -z "${qb_reaped:-}" ]; then
            if wait "${qb_pid}" >/dev/null 2>&1; then
                qb_exit_code=0
            else
                qb_exit_code=$?
            fi
            qb_reaped=1
        fi
    }

    qb_exit_code=0

    trap cleanup EXIT
    trap 'terminate; exit ${qb_exit_code:-0}' INT TERM

    if bashio::config.true 'silent'; then
        s6-notifyoncheck -d -n 300 -w 1000 -c "nc -z localhost ${WEBUI_PORT}" \
            s6-setuidgid abc /usr/bin/qbittorrent-nox --webui-port="${WEBUI_PORT}" > /dev/null &
    else
        s6-notifyoncheck -d -n 300 -w 1000 -c "nc -z localhost ${WEBUI_PORT}" \
            s6-setuidgid abc /usr/bin/qbittorrent-nox --webui-port="${WEBUI_PORT}" &
    fi

    qb_pid=$!
    if ! wait "${qb_pid}"; then
        qb_exit_code=$?
    else
        qb_exit_code=0
    fi
    qb_reaped=1

    exit "${qb_exit_code}"
fi
